# История изменений - Добавление аутентификации

## Дата: 28 октября 2025

### Обзор
Добавлена полная система аутентификации с использованием HTTP-only cookies, Pinia store и защитой маршрутов.

---

## Изменённые файлы

### 1. `src/services/authService.js` ✅ ОБНОВЛЁН
**Что добавлено:**
- `login(credentials)` - вход в систему
- `register(userData)` - регистрация пользователя
- `logout()` - выход из системы
- `getCurrentUser()` - получение данных текущего пользователя
- `checkAuth()` - проверка аутентификации

**Особенности:**
- Все методы работают с cookies (не требуется ручное управление токенами)
- Полная интеграция с Spring Security бэкендом

---

### 2. `src/services/api.js` ✅ ОБНОВЛЁН
**Что добавлено:**
- Response interceptor для обработки 401 ошибок
- Автоматический редирект на `/auth` при неавторизованном доступе

**Настройки:**
```javascript
{
  baseURL: 'http://localhost:8082/api',
  withCredentials: true,  // Критично для cookies!
  timeout: 10000
}
```

---

### 3. `src/store/auth.js` ✨ НОВЫЙ ФАЙЛ
**Pinia store для управления аутентификацией**

**State:**
- `user` - данные пользователя
- `loading` - состояние загрузки
- `error` - ошибки

**Getters:**
- `isAuthenticated` - авторизован ли пользователь
- `isAdmin` - имеет ли роль ADMIN/MANAGER
- `username` - имя пользователя
- `userRoles` - список всех ролей

**Actions:**
- `login()`, `register()`, `logout()`
- `fetchUser()`, `checkAuth()`
- `clearError()`

---

### 4. `src/router/index.js` ✅ ОБНОВЛЁН
**Что добавлено:**
- Navigation guard для защиты приватных маршрутов
- Meta-поле `requiresAuth` для маркировки защищенных страниц
- Автоматическая проверка аутентификации перед переходом
- Сохранение целевого URL для редиректа после входа

**Защищённые маршруты:**
- `/profile`
- `/contracts`
- `/contract/new`

---

### 5. `src/views/AuthView.vue` ✅ ПОЛНОСТЬЮ ПЕРЕРАБОТАН
**Новые возможности:**
- Вкладки для переключения между входом и регистрацией
- Красивый UI с градиентами и анимациями
- Валидация паролей (совпадение при регистрации)
- Отображение ошибок и успешных сообщений
- Автоматический переход на форму входа после регистрации
- Интеграция с Pinia auth store

**Поля формы входа:**
- Логин
- Пароль

**Поля формы регистрации:**
- Логин
- Email
- Пароль
- Подтверждение пароля

---

### 6. `src/components/layout/Header.vue` ✅ ОБНОВЛЁН
**Изменения:**
- Использует Pinia auth store вместо локального состояния
- Адаптивное меню в зависимости от статуса аутентификации
- Отображение имени пользователя
- Кнопка выхода
- Специальная ссылка для администраторов
- Улучшенные стили с hover эффектами
- Мобильная адаптивность

**Меню для гостей:**
- Каталог
- Вход / Регистрация

**Меню для авторизованных:**
- Каталог
- Мои договоры
- Профиль
- [Имя пользователя]
- Выйти

**Для администраторов дополнительно:**
- Админ панель (красная ссылка)

---

## Новые файлы документации

### 7. `AUTH_README.md` ✨ НОВЫЙ
Полная техническая документация по системе аутентификации:
- Архитектура
- API endpoints
- Примеры использования
- Настройки безопасности
- Pinia store API
- Роли пользователей
- Troubleshooting

### 8. `QUICKSTART.md` ✨ НОВЫЙ
Быстрый старт для разработчиков:
- Что было добавлено
- Как использовать
- Проверка работы
- Настройка бэкенда
- Решение проблем

---

## Технические детали

### Безопасность
- ✅ HTTP-only cookies - защита от XSS
- ✅ SameSite=Lax - защита от CSRF
- ✅ Время жизни токена: 30 минут
- ✅ Автоматическая очистка при выходе

### Интеграция с бэкендом
**Соответствие Spring Security endpoints:**
- `POST /api/auth` → Вход (SecurityConfig)
- `POST /api/registration` → Регистрация
- `POST /api/logout` → Выход
- `GET /api/profile/me` → Данные пользователя

### Cookie настройки (бэкенд):
```java
ResponseCookie.from("access_token", token)
    .httpOnly(true)
    .secure(false)  // true в production
    .path("/api")
    .maxAge(30*60)  // 30 минут
    .sameSite("Lax")
```

---

## Зависимости

Все необходимые пакеты уже установлены:
- ✅ `vue` ^3.3.0
- ✅ `vue-router` ^4.2.0
- ✅ `pinia` ^3.0.3
- ✅ `axios` ^1.12.2

---

## Как протестировать

### 1. Запуск
```bash
npm run dev
```

### 2. Проверка регистрации
1. Откройте `http://localhost:5173/auth`
2. Перейдите на вкладку "Регистрация"
3. Заполните форму
4. Нажмите "Зарегистрироваться"
5. После успеха автоматически переключится на форму входа

### 3. Проверка входа
1. Введите логин и пароль
2. Нажмите "Войти"
3. При успехе будет редирект на главную страницу
4. В header появится имя пользователя и кнопка "Выйти"

### 4. Проверка защиты маршрутов
1. Попробуйте открыть `/profile` без авторизации
2. Должен быть редирект на `/auth`
3. После входа автоматический редирект обратно на `/profile`

### 5. Проверка выхода
1. Нажмите кнопку "Выйти" в header
2. Cookie будет удалён
3. Редирект на `/auth`

---

## Важные замечания

### ⚠️ CORS
Убедитесь, что Spring Boot бэкенд настроен на:
```java
.allowedOrigins("http://localhost:5173")
.allowCredentials(true)
```

### ⚠️ Production
Перед деплоем измените в `AuthController.java`:
```java
.secure(true)  // Только HTTPS
```

### ⚠️ API Base URL
Если бэкенд на другом порту, измените в `src/services/api.js`:
```javascript
baseURL: 'http://your-backend:port/api'
```

---

## Что можно улучшить в будущем

### Функциональность
- [ ] Валидация email на клиенте
- [ ] Проверка силы пароля
- [ ] "Запомнить меня" (refresh tokens)
- [ ] Восстановление пароля
- [ ] Двухфакторная аутентификация
- [ ] OAuth2 (Google, GitHub)

### UX
- [ ] Loading спиннеры
- [ ] Toast уведомления
- [ ] Анимации переходов
- [ ] Подтверждение email
- [ ] Капча при регистрации

### Безопасность
- [ ] Rate limiting на клиенте
- [ ] Автоматическое продление токена
- [ ] История входов
- [ ] Обнаружение подозрительной активности

---

## Структура проекта (итог)

```
frontend/
├── src/
│   ├── services/
│   │   ├── api.js              ✅ Обновлён
│   │   ├── authService.js      ✅ Обновлён
│   │   ├── carService.js       (без изменений)
│   │   ├── contractService.js  (без изменений)
│   │   └── profileService.js   (без изменений)
│   ├── store/
│   │   ├── index.js            (без изменений)
│   │   └── auth.js             ✨ Новый
│   ├── router/
│   │   └── index.js            ✅ Обновлён
│   ├── views/
│   │   ├── AuthView.vue        ✅ Обновлён
│   │   └── ...                 (без изменений)
│   ├── components/
│   │   └── layout/
│   │       └── Header.vue      ✅ Обновлён
│   └── ...
├── AUTH_README.md              ✨ Новый
├── QUICKSTART.md               ✨ Новый
└── CHANGELOG.md                ✨ Этот файл
```

---

## Поддержка

При возникновении проблем:
1. Проверьте консоль браузера (F12)
2. Проверьте Network вкладку для запросов
3. Убедитесь, что бэкенд работает
4. Проверьте CORS настройки
5. Смотрите `AUTH_README.md` раздел Troubleshooting

---

**Версия:** 1.0.0  
**Дата:** 28.10.2025  
**Статус:** ✅ Готово к использованию
